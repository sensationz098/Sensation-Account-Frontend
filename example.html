<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload</title>
    <!-- Include necessary CSS -->
    <link rel="stylesheet" href="./css/uploadfile.css">
    <!-- Include necessary JavaScript libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Upload File</h1>
        <label for="fileInput" id="fileInputLabel">Choose File</label>
        <input type="file" id="fileInput" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
        <!-- Div to dynamically generate mapping form based on selected file -->
        <div id="mappingForm" style="display: none;">
            <h2>Map Headers</h2>
        </div>
        <button id="uploadBtn">Upload</button>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('fileInput');
    const mappingForm = document.getElementById('mappingForm');
    const uploadBtn = document.getElementById('uploadBtn');

    // Event listener when file input changes
    fileInput.addEventListener('change', function() {
        const file = fileInput.files[0];
        if (file) {
            const fileExt = file.name.split('.').pop().toLowerCase();
            if (fileExt === 'csv' || fileExt === 'xlsx') {
                // Dynamically generate mapping form based on selected file
                parseHeaders(file); // Call function to parse headers
            } else {
                alert('Unsupported file format');
            }
        }
    });

    // Function to parse headers from the selected file
    function parseHeaders(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const headers = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0]; // Extract headers from the first row
            generateMappingForm(headers); // Generate mapping form based on extracted headers
        };
        reader.readAsArrayBuffer(file);
    }

    // Function to dynamically generate mapping form
    function generateMappingForm(headers) {
        // Clear existing form content
        mappingForm.innerHTML = '<h2>Map Headers</h2>';
        const fields = ['name', 'contact', 'course', 'date_of_payment', 'courseStartDate', 'courseEndDate', 'fee', 'courseDuration', 'assignedUserId'];
        fields.forEach(field => {
            const fieldLabel = document.createElement('label');
            fieldLabel.textContent = field + ':';
            const selectField = document.createElement('select');
            selectField.name = field.replace(/\s+/g, '');
            selectField.innerHTML = '<option value="">Select Field</option>';
            // Populate select options with extracted headers
            Object.keys(headers).forEach(header => {
                selectField.innerHTML += `<option value="${headers[header]}">${headers[header]}</option>`;
            });
            const fieldDiv = document.createElement('div');
            fieldDiv.classList.add('field');
            fieldDiv.appendChild(fieldLabel);
            fieldDiv.appendChild(selectField);
            mappingForm.appendChild(fieldDiv);
        });
        // Set the display property of mappingForm to 'block'
        mappingForm.style.display = 'block';
    }

    // Event listener when upload button is clicked
    uploadBtn.addEventListener('click', function() {
        // Prepare and log the request data
        const requestData = prepareRequestData();
        console.log('Request data:', requestData);

        // Send the request to the backend
        fetch('http://localhost:9090/fileupload/upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to upload file');
            }
            return response.json();
        })
        .then(data => {
            console.log('Response from server:', data);
            // Handle success response from server
        })
        .catch(error => {
            console.error('Error uploading file:', error);
            // Handle error response from server
        });
    });

    // Function to prepare request data
    function prepareRequestData() {
        const selectedMappings = {};
        const selectFields = document.querySelectorAll('select');
        selectFields.forEach(select => {
            const fieldName = select.name; // Get the field name
            let selectedValue = select.value; // Get the selected value
            // Convert date fields to ISO 8601 format using Moment.js
            if (fieldName.includes('date') || fieldName.includes('Date')) {
                selectedValue = moment(selectedValue).toISOString();
            }
            selectedMappings[fieldName] = selectedValue; // Map the field name to the selected value
        });
        return selectedMappings;
    }
});

    </script>
    
</body>
</html>
