<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/editStudent.css">
</head>
<body>

    <h2>Modal Form Example</h2>
    
    <form id="modalForm">
      <!-- Student Name -->
      <div>
        <label for="editName">Name:</label><br>
        <input type="text" id="editName" name="editName" required><br>
      </div>
      
      <!-- Email -->
      <div>
        <label for="editEmail">Email:</label><br>
        <input type="email" id="editEmail" name="editEmail" required><br>
      </div>
    
      <!-- Contact -->
      <div>
        <label for="editContact">Contact:</label><br>
        <input type="tel" id="editContact" name="editContact" required><br>
      </div>
    
      <!-- Assigned Users Dropdown -->
      <div>
        <label for="editAssignedUser">Assigned User:</label><br>
        <select id="editAssignedUser" name="editAssignedUser" required>
          <!-- Assigned users options will be dynamically added here -->
        </select><br>
      </div>
    
      <!-- Course Dropdown -->
      <div>
        <label for="editCourse">Course:</label><br>
        <select id="editCourse" name="editCourse" required>
        </select><br>
      </div>
    
    
      <!-- Timing -->
      <div>
        <label for="editTiming">Timing:</label><br>
        <select id="editTiming" name="editTiming" required>
          <option value="5-6 am (Morning)">5-6 am (Morning)</option>
          <option value="6-7 am (Morning)">6-7 am (Morning)</option>
          <option value="7-8 am (Morning)">7-8 am (Morning)</option>
          <option value="8-9 am (Morning)">8-9 am (Morning)</option>
          <option value="9-10 am (Morning)">9-10 am (Morning)</option>
          <option value="10-11 am (Morning)">10-11 am (Morning)</option>
          <option value="11 am - 12 pm (Morning)">11 am - 12 pm (Morning)</option>
          <option value="12-1 pm (Afternoon)">12-1 pm (Afternoon)</option>
          <option value="1-2 pm (Afternoon)">1-2 pm (Afternoon)</option>
          <option value="2-3 pm (Afternoon)">2-3 pm (Afternoon)</option>
          <option value="3-4 pm (Afternoon)">3-4 pm (Afternoon)</option>
          <option value="4-5 pm (Afternoon)">4-5 pm (Afternoon)</option>
          <option value="5-6 pm (Evening)">5-6 pm (Evening)</option>
          <option value="6-7 pm (Evening)">6-7 pm (Evening)</option>
          <option value="7-8 pm (Evening)">7-8 pm (Evening)</option>
          <option value="8-9 pm (Evening)">8-9 pm (Evening)</option>
        </select><br>
      </div>
    
      <!-- Course Start Date -->
      <div>
        <label for="editCourseStartDate">Course Start Date:</label><br>
        <input type="date" id="editCourseStartDate" name="editCourseStartDate" required><br>
      </div>
    
      <!-- Course End Date -->
      <div>
        <label for="editCourseEndDate">Course End Date:</label><br>
        <input type="date" id="editCourseEndDate" name="editCourseEndDate" required><br>
      </div>
    
      <!-- Date of Payment -->
      <div>
        <label for="editDateOfPayment">Date of Payment:</label><br>
        <input type="date" id="editDateOfPayment" name="editDateOfPayment" required><br>
      </div>

      <div>
        <label for="editTeacherName">Teacher:</label><br>
        <select name="editTeacherName" id="editTeacherName" required></select>
      </div>
    
      <!-- State Dropdown -->
      <div>
        <label for="editState">State:</label><br>
        <select id="editState" name="editState" required>
          <optgroup label="States">
            <option value="Andhra Pradesh">Andhra Pradesh</option>
            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
            <option value="Assam">Assam</option>
            <option value="Bihar">Bihar</option>
            <option value="Chhattisgarh">Chhattisgarh</option>
            <option value="Goa">Goa</option>
            <option value="Gujarat">Gujarat</option>
            <option value="Haryana">Haryana</option>
            <option value="Himachal Pradesh">Himachal Pradesh</option>
            <option value="Jharkhand">Jharkhand</option>
            <option value="Karnataka">Karnataka</option>
            <option value="Kerala">Kerala</option>
            <option value="Madhya Pradesh">Madhya Pradesh</option>
            <option value="Maharashtra">Maharashtra</option>
            <option value="Manipur">Manipur</option>
            <option value="Meghalaya">Meghalaya</option>
            <option value="Mizoram">Mizoram</option>
            <option value="Nagaland">Nagaland</option>
            <option value="Odisha">Odisha</option>
            <option value="Punjab">Punjab</option>
            <option value="Rajasthan">Rajasthan</option>
            <option value="Sikkim">Sikkim</option>
            <option value="Tamil Nadu">Tamil Nadu</option>
            <option value="Telangana">Telangana</option>
            <option value="Tripura">Tripura</option>
            <option value="Uttar Pradesh">Uttar Pradesh</option>
            <option value="Uttarakhand">Uttarakhand</option>
            <option value="West Bengal">West Bengal</option>
        </optgroup>
        <optgroup label="Union Territories">
            <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
            <option value="Chandigarh">Chandigarh</option>
            <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
            <option value="Delhi">Delhi</option>
            <option value="Lakshadweep">Lakshadweep</option>
            <option value="Ladakh">Ladakh</option>
            <option value="Puducherry">Puducherry</option>
        </optgroup>
        </select><br>
      </div>
    
      <!-- Fee -->
      <div>
        <label for="editFee">Fee:</label><br>
        <input type="number" id="editFee" name="editFee" required><br>
      </div>
    
      <!-- Course Duration -->
      <div>
        <label for="editCourseDuration">Course Duration:</label><br>
        <input type="text" id="editCourseDuration" name="editCourseDuration" required><br>
      </div>
    
      <button type="submit">Submit</button>
    </form>



    <script>
 let studentData = JSON.parse(localStorage.getItem('StudentData'));
let tokenData = JSON.parse(localStorage.getItem('Data'))
let token = tokenData.token



document.addEventListener('DOMContentLoaded', async function() {


    
document.getElementById('editName').value = studentData.name || '';
document.getElementById('editEmail').value = studentData.email || '';
document.getElementById('editContact').value = studentData.contact || '';
document.getElementById('editCourse').value = studentData.course || '';
document.getElementById('editTiming').value = studentData.timing || '';
document.getElementById('editCourseStartDate').value = formatDate(studentData.courseStartDate) || '';
document.getElementById('editCourseEndDate').value = formatDate(studentData.courseEndDate) || '';
document.getElementById('editDateOfPayment').value = formatDate(studentData.date_of_payment) || '';
document.getElementById('editState').value = studentData.state || '';
document.getElementById('editFee').value = studentData.fee || '';
document.getElementById('editCourseDuration').value = studentData.CourseDuration || '';
document.getElementById('editTeacherName').value = studentData.Teacher || '';

// Fetch courses from the API
try {
    const response = await fetch(`http://localhost:9090/courses`, {
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token
        }
    });
    if (!response.ok) {
        throw new Error(`Failed to fetch courses: ${response.status} ${response.statusText}`);
    }
    const courses = await response.json();
    console.log(courses); // Log courses array to console to check if it's fetched correctly

    // Populate options
    const editCourseSelect = document.getElementById('editCourse'); // Get reference to the select element
    editCourseSelect.innerHTML = ''; // Clear existing options
    

    courses.forEach(course => {
        const option = document.createElement('option');
        option.value = course.coursename; // Assuming 'coursename' is the property containing course name
        option.textContent = course.coursename;
        editCourseSelect.appendChild(option); // Add option to select element
    });

    // If studentData already has a selected course, set it as selected
    if (studentData.course) {
        editCourseSelect.value = studentData.course;
    }

} catch (error) {
    console.error('Error fetching courses:', error);
}


try {
    const response = await fetch(`http://localhost:9090/teachers`, {
        headers: {
            'Content-Type': 'application/json',
            'Authorization':token
        }
    });
    if (!response.ok) {
        throw new Error(`Failed to fetch teachers: ${response.status} ${response.statusText}`);
    }
    const teachers = await response.json();
    console.log(teachers)
    const teacherSelect = document.getElementById('editTeacherName');
    teacherSelect.innerHTML = ''; // Clear existing options

    teachers.forEach(teacher => {
        const option2 = document.createElement('option');
        option2.value = teacher.TeacherName; // Assuming '_id' is the property containing teacher ID
        option2.textContent = teacher.TeacherName; // Assuming 'teacherName' is the property containing teacher name
        teacherSelect.appendChild(option2);
    });

    teacherSelect.value = studentData.Teacher

} catch (error) {
    console.error('Error fetching teachers:', error);
    // Handle error condition here, display error message or take appropriate action
}


// Populate assigned users dropdown
const assignedUserSelect = document.getElementById('editAssignedUser');
const assignedUserId = studentData.assignedUserId || '';

// Fetch assigned users from the API
try {
  const response = await fetch(`http://localhost:9090/user/allusers`, {
      headers: {
          'Content-Type': 'application/json',
          'Authorization': token
      }
  });
  const users = await response.json();

  // Populate options
  let assignedUserOption;

  users.forEach(user => {
      if (user.role === 'user') {
          const option = document.createElement('option');
          option.value = user._id;
          option.textContent = user.username;
          if (user._id === assignedUserId) {
              assignedUserOption = option; // Save assigned user option separately
          } else {
              assignedUserSelect.appendChild(option); // Add normally
          }
      }
  });

  // Add assigned user option to the top
  if (assignedUserOption) {
      assignedUserOption.selected = true; // Select the assigned user option
      assignedUserSelect.insertBefore(assignedUserOption, assignedUserSelect.firstChild);
  }

} catch (error) {
  console.error('Error fetching assigned users:', error);
}

// Submit event listener
document.getElementById('modalForm').addEventListener('submit', async function(event) {
  event.preventDefault();

  
  const studentId = studentData._id; // Replace with the actual student ID

  const requestBody = {
      name: document.getElementById('editName').value,
      email: document.getElementById('editEmail').value,
      contact: document.getElementById('editContact').value,
      course: document.getElementById('editCourse').value,
      assignedUserId: document.getElementById('editAssignedUser').value, // Change key to assignedUserId
      timing: document.getElementById('editTiming').value,
      date_of_payment: document.getElementById('editDateOfPayment').value,
      state: document.getElementById('editState').value,
      courseStartDate: document.getElementById('editCourseStartDate').value,
      courseEndDate: document.getElementById('editCourseEndDate').value,
      fee: document.getElementById('editFee').value,
      CourseDuration: document.getElementById('editCourseDuration').value,
      Teacher: document.getElementById('editTeacherName').value

  };

 
  try {
      const response = await fetch(`http://localhost:9090/user/student/edit/${studentId}`, {
          method: 'PUT',
          headers: {
              'Content-Type': 'application/json',
              'Authorization': token
          },
          body: JSON.stringify(requestBody)
      });

      if (response.ok) {
        console.log(requestBody)
          alert('Student details updated successfully.');

        //   location.reload(); // Reload the page after successful update
      } else {
          const errorMessage = await response.text();
          throw new Error(errorMessage);
      }
  } catch (error) {
      console.error('Error updating student details:', error);
      alert('Failed to update student details. Please try again.');
  }
});
});



function formatDate(inputDate) {
const date = new Date(inputDate);

if (isNaN(date.getTime())) {
  // Invalid date, return an empty string or handle it as needed
  return '';
}

const year = date.getFullYear();
const month = String(date.getMonth() + 1).padStart(2, '0');
const day = String(date.getDate()).padStart(2, '0');
return `${year}-${month}-${day}`;
}


    </script>
      
  
  
  
  </body>
</html>